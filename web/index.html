<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShowSwap - Friend TV Recommendations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
        .show-card { transition: all 0.2s ease; }
        .show-card:hover { transform: scale(1.02); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center py-12 px-4">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-900">Welcome to ShowSwap</h2>
                <p class="mt-2 text-sm text-gray-600">Discover shows through your friends' recommendations</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <input type="text" id="username" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                       placeholder="Enter your username">
                <button type="submit" 
                        class="w-full py-2 px-4 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-4xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">ShowSwap</h1>
                    <div class="flex space-x-4">
                        <button id="nav-dashboard" class="px-3 py-2 text-blue-600 font-medium">Dashboard</button>
                        <button id="nav-add-show" class="px-3 py-2 text-gray-600 hover:text-blue-600">Add Show</button>
                        <button id="nav-my-lists" class="px-3 py-2 text-gray-600 hover:text-blue-600">My Lists</button>
                        <button id="logout-btn" class="px-3 py-2 text-red-600 hover:text-red-700">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard -->
        <div id="dashboard-screen" class="max-w-4xl mx-auto px-4 py-8">
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">Dashboard</h2>
                
                <!-- Currently Watching Section -->
                <div id="currently-watching-section" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Currently Watching</h3>
                    <div id="currently-watching-content" class="text-gray-500">
                        Loading...
                    </div>
                </div>
                
                <!-- Recently Watched Section -->
                <div id="recently-watched-section" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Recently Watched</h3>
                    <div id="recently-watched-content" class="text-gray-500">
                        Loading...
                    </div>
                </div>
                
                <!-- Top Compatible Friends Section -->
                <div id="compatible-friends-section" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Compatible Friends</h3>
                    <div id="compatible-friends-content" class="text-gray-500">
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Show -->
        <div id="add-show-screen" class="hidden max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Add New Show</h2>
                <form id="add-show-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Show Title</label>
                        <input type="text" id="show-title" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Platform</label>
                        <select id="show-platform" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Platform</option>
                            <option value="Netflix">Netflix</option>
                            <option value="Hulu">Hulu</option>
                            <option value="HBO Max">HBO Max</option>
                            <option value="Apple TV+">Apple TV+</option>
                            <option value="Amazon Prime">Amazon Prime</option>
                            <option value="Disney+">Disney+</option>
                            <option value="Other">Other</option>
                        </select>
                        <div id="custom-platform-section" class="hidden mt-2">
                            <input type="text" id="custom-platform" placeholder="Enter platform name..." maxlength="50" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-sm text-gray-500 mt-1">Max 50 characters</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="status" value="WatchLater" checked class="mr-2">
                                <span>Watch Later</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="status" value="WatchingNow" class="mr-2">
                                <span>Currently Watching</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="status" value="Watched" class="mr-2">
                                <span>Watched (requires rating)</span>
                            </label>
                        </div>
                    </div>
                    <div id="rating-section" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                        <div class="flex space-x-1">
                            <button type="button" class="heart-btn text-2xl" data-rating="1">üñ§</button>
                            <button type="button" class="heart-btn text-2xl" data-rating="2">üñ§</button>
                            <button type="button" class="heart-btn text-2xl" data-rating="3">üñ§</button>
                            <button type="button" class="heart-btn text-2xl" data-rating="4">üñ§</button>
                            <button type="button" class="heart-btn text-2xl" data-rating="5">üñ§</button>
                        </div>
                        <input type="hidden" id="show-rating" value="">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        Add Show
                    </button>
                </form>
            </div>
        </div>

        <!-- My Lists -->
        <div id="my-lists-screen" class="hidden max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">My Lists</h2>
                
                <!-- Tabs -->
                <div class="flex space-x-4 mb-6 border-b">
                    <button id="tab-watching" class="px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">Currently Watching</button>
                    <button id="tab-later" class="px-4 py-2 font-medium text-gray-600 hover:text-blue-600">Watch Later</button>
                    <button id="tab-watched" class="px-4 py-2 font-medium text-gray-600 hover:text-blue-600">Watched</button>
                </div>

                <!-- Lists Content -->
                <div id="watching-now-list" class="space-y-4">
                    <p class="text-gray-600 text-center py-8">No shows currently watching</p>
                </div>
                <div id="watch-later-list" class="hidden space-y-4"></div>
                <div id="watched-list" class="hidden space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let selectedRating = 0;

        // API functions
        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`/api${endpoint}`, {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });
            return response.json();
        }

        // Auth functions
        async function login(username) {
            const result = await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ username })
            });
            
            if (result.user) {
                currentUser = result.user;
                showScreen('main-app');
                loadMyLists();
                return true;
            }
            return false;
        }

        async function logout() {
            await apiCall('/auth/logout', { method: 'POST' });
            currentUser = null;
            showScreen('login-screen');
        }

        // Show functions
        async function addShow(title, platform, status, rating = null) {
            const body = { title, platform, initialStatus: status };
            if (rating) body.rating = rating;
            
            return await apiCall('/shows', {
                method: 'POST',
                body: JSON.stringify(body)
            });
        }

        async function loadMyLists() {
            const lists = await apiCall('/my/lists');
            
            // Update watching now
            const watchingList = document.getElementById('watching-now-list');
            if (lists.watchingNow.length === 0) {
                watchingList.innerHTML = '<p class="text-gray-600 text-center py-8">No shows currently watching</p>';
            } else {
                watchingList.innerHTML = lists.watchingNow.map(show => createShowCard(show)).join('');
            }
            
            // Update watch later
            const laterList = document.getElementById('watch-later-list');
            if (lists.watchLater.length === 0) {
                laterList.innerHTML = '<p class="text-gray-600 text-center py-8">No shows in watch later</p>';
            } else {
                laterList.innerHTML = lists.watchLater.map(show => createShowCard(show)).join('');
            }
            
            // Update watched
            const watchedList = document.getElementById('watched-list');
            if (lists.watched.length === 0) {
                watchedList.innerHTML = '<p class="text-gray-600 text-center py-8">No watched shows</p>';
            } else {
                watchedList.innerHTML = lists.watched.map(show => createShowCard(show, true)).join('');
            }
        }

        function createShowCard(show, showRating = false) {
            const ratingStars = showRating && show.rating ? '‚ù§Ô∏è'.repeat(show.rating) : '';
            return `
                <div class="show-card bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-lg">${show.title}</h3>
                            <p class="text-gray-600">${show.platform}</p>
                            ${showRating && ratingStars ? `<p class="text-yellow-500 mt-1">${ratingStars} (${show.rating}/5)</p>` : ''}
                        </div>
                        <span class="text-xs text-gray-500">Added ${new Date(show.addedAt).toLocaleDateString()}</span>
                    </div>
                </div>
            `;
        }

        // UI functions
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('#login-screen, #main-app').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#dashboard-screen, #add-show-screen, #my-lists-screen').forEach(el => el.classList.add('hidden'));
            
            // Show target screen
            document.getElementById(screenId).classList.remove('hidden');
            
            if (screenId === 'main-app') {
                showMainScreen('dashboard-screen');
            }
        }

        function showMainScreen(screenId) {
            document.querySelectorAll('#dashboard-screen, #add-show-screen, #my-lists-screen').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            // Update nav
            document.querySelectorAll('#nav-dashboard, #nav-add-show, #nav-my-lists').forEach(el => {
                el.classList.remove('text-blue-600');
                el.classList.add('text-gray-600');
            });
            
            const navMap = {
                'dashboard-screen': 'nav-dashboard',
                'add-show-screen': 'nav-add-show',
                'my-lists-screen': 'nav-my-lists'
            };
            
            if (navMap[screenId]) {
                const activeNav = document.getElementById(navMap[screenId]);
                activeNav.classList.remove('text-gray-600');
                activeNav.classList.add('text-blue-600');
            }
        }

        // Event listeners
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            await login(username);
        });

        document.getElementById('logout-btn').addEventListener('click', logout);

        // Navigation
        document.getElementById('nav-dashboard').addEventListener('click', () => {
            showMainScreen('dashboard-screen');
            loadDashboardData();
        });
        document.getElementById('nav-add-show').addEventListener('click', () => showMainScreen('add-show-screen'));
        document.getElementById('nav-my-lists').addEventListener('click', () => {
            showMainScreen('my-lists-screen');
            loadMyLists();
        });

        // Add show form
        document.querySelectorAll('input[name="status"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const ratingSection = document.getElementById('rating-section');
                if (e.target.value === 'Watched') {
                    ratingSection.classList.remove('hidden');
                } else {
                    ratingSection.classList.add('hidden');
                    selectedRating = 0;
                    updateHearts(0);
                }
            });
        });

        // Platform dropdown change handler
        document.getElementById('show-platform').addEventListener('change', (e) => {
            const customSection = document.getElementById('custom-platform-section');
            const customInput = document.getElementById('custom-platform');
            
            if (e.target.value === 'Other') {
                customSection.classList.remove('hidden');
                customInput.required = true;
                customInput.focus();
            } else {
                customSection.classList.add('hidden');
                customInput.required = false;
                customInput.value = '';
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('heart-btn')) {
                e.preventDefault();
                selectedRating = parseInt(e.target.dataset.rating);
                document.getElementById('show-rating').value = selectedRating;
                updateHearts(selectedRating);
                console.log('Heart clicked:', selectedRating);
            }
        });

        function updateHearts(rating) {
            document.querySelectorAll('.heart-btn').forEach((btn, index) => {
                console.log(`Updating heart ${index + 1}, should be ${index < rating ? 'red' : 'grey'}`);
                
                if (index < rating) {
                    btn.textContent = '‚ù§Ô∏è'; // Red heart emoji
                } else {
                    btn.textContent = 'üñ§'; // Grey heart emoji
                }
            });
        }

        // Toast function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        document.getElementById('add-show-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('show-title').value;
            const platformDropdown = document.getElementById('show-platform').value;
            const customPlatform = document.getElementById('custom-platform').value;
            const platform = platformDropdown === 'Other' ? customPlatform : platformDropdown;
            const status = document.querySelector('input[name="status"]:checked').value;
            const rating = status === 'Watched' ? selectedRating : null;
            
            if (status === 'Watched' && !rating) {
                showToast('Please select a rating for watched shows', 'error');
                return;
            }
            
            const result = await addShow(title, platform, status, rating);
            
            if (result.show) {
                showToast('Show added successfully!');
                
                // Clear form completely
                document.getElementById('add-show-form').reset();
                selectedRating = 0;
                updateHearts(0); // Reset hearts to black
                document.getElementById('rating-section').classList.add('hidden');
                document.getElementById('custom-platform-section').classList.add('hidden');
                document.getElementById('custom-platform').required = false;
                
                // Reset radio buttons to default (Watch Later)
                document.querySelector('input[value="WatchLater"]').checked = true;
            }
        });

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard');
                const data = await response.json();
                
                populateCurrentlyWatching(data.currentlyWatching);
                populateRecentlyWatched(data.recentlyWatched);
                populateCompatibleFriends(data.compatibleFriends);
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        function populateCurrentlyWatching(currentlyWatching) {
            const content = document.getElementById('currently-watching-content');
            
            if (!currentlyWatching.recent) {
                content.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-500">No shows currently watching</p>
                        <button onclick="showMainScreen('add-show-screen')" class="mt-2 text-blue-600 hover:text-blue-800">Add a show</button>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900">${currentlyWatching.recent.title}</h4>
                        <p class="text-sm text-gray-600">${currentlyWatching.recent.platform}</p>
                        <p class="text-xs text-gray-500">Added ${new Date(currentlyWatching.recent.addedAt).toLocaleDateString()}</p>
                    </div>
                    ${currentlyWatching.hasMore ? `
                        <button onclick="showMyListsTab('watching-now-list')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Show More (${currentlyWatching.total})
                        </button>
                    ` : ''}
                </div>
            `;
        }

        function populateRecentlyWatched(recentlyWatched) {
            const content = document.getElementById('recently-watched-content');
            
            if (!recentlyWatched.recent) {
                content.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-500">No shows watched yet</p>
                        <button onclick="showMainScreen('add-show-screen')" class="mt-2 text-blue-600 hover:text-blue-800">Add a watched show</button>
                    </div>
                `;
                return;
            }
            
            const stars = '‚ù§Ô∏è'.repeat(recentlyWatched.recent.rating || 0) + 'üñ§'.repeat(5 - (recentlyWatched.recent.rating || 0));
            
            content.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900">${recentlyWatched.recent.title}</h4>
                        <p class="text-sm text-gray-600">${recentlyWatched.recent.platform}</p>
                        <p class="text-sm">${stars}</p>
                        <p class="text-xs text-gray-500">Watched ${new Date(recentlyWatched.recent.addedAt).toLocaleDateString()}</p>
                    </div>
                    ${recentlyWatched.hasMore ? `
                        <button onclick="showMyListsTab('watched-list')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            More (${recentlyWatched.total})
                        </button>
                    ` : ''}
                </div>
            `;
        }

        function populateCompatibleFriends(friends) {
            const content = document.getElementById('compatible-friends-content');
            
            if (friends.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-500">No friends to show compatibility with</p>
                        <p class="text-xs text-gray-400 mt-1">Add friends to see compatibility scores</p>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <div class="space-y-3">
                    ${friends.map(friend => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">${friend.username}</h4>
                                <p class="text-sm text-gray-600">${friend.sharedShows} shared shows</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-lg font-bold text-green-600">${friend.compatibility}%</span>
                                <button onclick="showFriendProfile('${friend.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    View Profile
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 text-center">
                    <button onclick="showMainScreen('friends-screen')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        View All Friends
                    </button>
                </div>
            `;
        }

        // Navigation helpers
        function showMyListsTab(tabName) {
            showMainScreen('my-lists-screen');
            // Activate the specific tab
            setTimeout(() => {
                const tabMap = {
                    'watching-now-list': 'tab-watching',
                    'watched-list': 'tab-watched'
                };
                const tabId = tabMap[tabName];
                if (tabId) {
                    showListTab(tabName, tabId);
                }
            }, 100);
        }

        function showFriendProfile(friendId) {
            // For now, show friends screen - will be enhanced later
            showMainScreen('friends-screen');
        }

        // My Lists tabs
        document.getElementById('tab-watching').addEventListener('click', () => {
            showListTab('watching-now-list', 'tab-watching');
        });
        
        document.getElementById('tab-later').addEventListener('click', () => {
            showListTab('watch-later-list', 'tab-later');
        });
        
        document.getElementById('tab-watched').addEventListener('click', () => {
            showListTab('watched-list', 'tab-watched');
        });

        function showListTab(listId, tabId) {
            document.querySelectorAll('#watching-now-list, #watch-later-list, #watched-list').forEach(el => el.classList.add('hidden'));
            document.getElementById(listId).classList.remove('hidden');
            
            document.querySelectorAll('#tab-watching, #tab-later, #tab-watched').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                el.classList.add('text-gray-600');
            });
            
            const activeTab = document.getElementById(tabId);
            activeTab.classList.remove('text-gray-600');
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        }

        // Test API button
        document.getElementById('test-api-btn').addEventListener('click', async () => {
            try {
                // Test adding some shows
                await addShow('Severance', 'Apple TV+', 'Watched', 5);
                await addShow('Watchmen', 'HBO Max', 'WatchLater');
                await addShow('The Office', 'Netflix', 'WatchingNow');
                
                alert('Test data added! Check "My Lists" to see the results.');
                loadMyLists();
            } catch (error) {
                alert('Error testing API: ' + error.message);
            }
        });
    </script>
</body>
</html>